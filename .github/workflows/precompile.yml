name: precompile

env:
  ZLIB_VERSION: "1.3"
  LIBXML2_VERSION: "2.11.5"
  OPENSSL_VERSION: "3.1.3"
  LIBSSH2_VERSION: "1.11.0"
  LIBCARES2_VERSION: "1.20.1"
  SQLITE3_VERSION: "3430200"
  ARIA2_COMMIT: "076dea3896dba6a8e2acc683818ff60602efa9d4"
  ARIA2_COMMIT_SHORT: "076dea3"

on:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - pair:
              arch: x86_64-linux-gnu
              cc: gcc
              cpp: g++
              gcc: gcc
          - pair:
              arch: aarch64-linux-gnu
              cc: gcc-aarch64-linux-gnu
              cpp: g++-aarch64-linux-gnu
              gcc: aarch64-linux-gnu-gcc
              openssl_configure: linux-aarch64
              openssl_prefix: "--cross-compile-prefix=/usr/bin/aarch64-linux-gnu-"
              cmake_toolchain_file: cc_toolchain/aarch64-linux-gnu.cmake
          - pair:
              arch: arm-linux-gnueabihf
              cc: gcc-arm-linux-gnueabihf
              cpp: g++-arm-linux-gnueabihf
              gcc: arm-linux-gnueabihf-gcc
              openssl_configure: linux-generic32
              openssl_prefix: "--cross-compile-prefix=/usr/bin/arm-linux-gnueabihf-"
              cmake_toolchain_file: cc_toolchain/armv7l-linux-gnueabihf.cmake
          - pair:
              arch: riscv64-linux-gnu
              cc: gcc-riscv64-linux-gnu
              cpp: g++-riscv64-linux-gnu
              gcc: riscv64-linux-gnu-gcc
              openssl_configure: linux64-riscv64
              openssl_prefix: "--cross-compile-prefix=/usr/bin/riscv64-linux-gnu-"
              cmake_toolchain_file: cc_toolchain/riscv64-linux-gnu.cmake

    name: ${{ matrix.pair.arch }}

    steps:
      - uses: actions/checkout@v4
      - name: Create directories
        run: |
          mkdir -p "src"
          mkdir -p "tarballs"
          mkdir -p "deps"
          mkdir -p "releases"
      - name: Install C Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.pair.cc }} ${{ matrix.pair.cpp }} autoconf automake libtool autopoint gettext

      - name: Cache zlib
        uses: actions/cache@v3
        id: cache-zlib
        with:
          path: |
            tarballs/zlib-${{ env.ZLIB_VERSION }}.tar.gz
          key: tarballs-zlib-${{ env.ZLIB_VERSION }}
      - name: Get zlib
        if: steps.cache-zlib.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz" -o "tarballs/zlib-${ZLIB_VERSION}.tar.gz"

      - name: Cache libxml2
        uses: actions/cache@v3
        id: cache-libxml2
        with:
          path: |
            tarballs/libxml2-${{ env.LIBXML2_VERSION }}.tar.gz
          key: tarballs-libxml2-${{ env.LIBXML2_VERSION }}
      - name: Get libxml2
        if: steps.cache-libxml2.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://github.com/GNOME/libxml2/archive/refs/tags/v${LIBXML2_VERSION}.tar.gz" -o "tarballs/libxml2-v${LIBXML2_VERSION}.tar.gz"

      - name: Cache libc-ares2
        uses: actions/cache@v3
        id: cache-libc-ares2
        with:
          path: |
            tarballs/c-ares-${{ env.LIBCARES2_VERSION }}.tar.gz
          key: tarballs-libc-ares-${{ env.LIBCARES2_VERSION }}
      - name: Get libc-ares2
        if: steps.cache-libc-ares2.outputs.cache-hit != 'true'
        run: |
          export LIBCARES2_VERSION_UNDERSCORE=${LIBCARES2_VERSION//./_}
          curl -fSL "https://github.com/c-ares/c-ares/releases/download/cares-${LIBCARES2_VERSION_UNDERSCORE}/c-ares-${LIBCARES2_VERSION}.tar.gz" -o "tarballs/libc-ares-${LIBCARES2_VERSION}.tar.gz"

      - name: Cache OpenSSL
        uses: actions/cache@v3
        id: cache-openssl
        with:
          path: |
            tarballs/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          key: tarballs-openssl-${{ env.OPENSSL_VERSION }}
      - name: Get OpenSSL
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" -o "tarballs/openssl-${OPENSSL_VERSION}.tar.gz"

      - name: Cache libssh2
        uses: actions/cache@v3
        id: cache-libssh2
        with:
          path: |
            tarballs/libssh2-${{ env.LIBSSH2_VERSION }}.tar.gz
          key: tarballs-libssh2-${{ env.LIBSSH2_VERSION }}
      - name: Get libssh2
        if: steps.cache-libssh2.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://libssh2.org/download/libssh2-${LIBSSH2_VERSION}.tar.gz" -o "tarballs/libssh2-${LIBSSH2_VERSION}.tar.gz"

      - name: Cache SQLite3
        uses: actions/cache@v3
        id: cache-sqlite3
        with:
          path: |
            tarballs/sqlite-autoconf-${{ env.SQLITE3_VERSION }}.tar.gz
          key: tarballs-sqlite3-${{ env.SQLITE3_VERSION }}
      - name: Get SQLite3
        if: steps.cache-sqlite3.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://www.sqlite.org/2023/sqlite-autoconf-${SQLITE3_VERSION}.tar.gz" -o "tarballs/sqlite-autoconf-${SQLITE3_VERSION}.tar.gz"

      - name: Cache aria2
        uses: actions/cache@v3
        id: cache-aria2
        with:
          path: |
            src/aria2-${{ env.ARIA2_COMMIT }}
          key: src-aria2-${{ env.ARIA2_COMMIT }}
      - name: Get aria2
        if: steps.cache-aria2.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/uwulab/aria2.git src/aria2
          cd src/aria2
          git checkout "${{ env.ARIA2_COMMIT }}"
          cd ..
          mv src/aria2 src/aria2-${{ env.ARIA2_COMMIT }}

      - name: Cache compiled zlib
        uses: actions/cache@v3
        id: cache-zlib-shared
        with:
          path: |
            releases/zlib-${{ env.ZLIB_VERSION }}-${{ matrix.pair.arch }}.tar.gz
            deps/zlib/
          key: releases-shared-zlib-${{ env.ZLIB_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile zlib
        if: steps.cache-zlib-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          tar -xzf "tarballs/zlib-${ZLIB_VERSION}.tar.gz" -C src
          cd "src/zlib-${ZLIB_VERSION}"
          export CFLAGS="-fPIC"
          CC=${{ matrix.pair.gcc }} ./configure --prefix=/usr/local
          make -j$(nproc)
          make DESTDIR="${ROOT_DIR}/deps/zlib" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/zlib-${ZLIB_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C zlib .

      - name: Cache compiled libxml2
        uses: actions/cache@v3
        id: cache-libxml2-shared
        with:
          path: |
            releases/libxml2-${{ env.LIBXML2_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-shared-libxml2-${{ env.LIBXML2_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile libxml2
        if: steps.cache-libxml2-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          tar -xzf "tarballs/libxml2-v${LIBXML2_VERSION}.tar.gz" -C src
          cd "src/libxml2-${LIBXML2_VERSION}"
          export CMAKE_TOOLCHAIN_FILE=-DCMAKE_TOOLCHAIN_FILE="${ROOT_DIR}/${{ matrix.pair.cmake_toolchain_file }}"
          if [ -z "${{ matrix.pair.cmake_toolchain_file }}" ]; then
            export CMAKE_TOOLCHAIN_FILE=""
          fi
          cmake -S . -B libxml2-build \
              -D BUILD_STATIC_LIBS=OFF \
              -D CMAKE_BUILD_TYPE=Release \
              -D CMAKE_INSTALL_PREFIX=/usr/local \
              -D LIBXML2_WITH_ICONV=OFF \
              -D LIBXML2_WITH_LZMA=OFF \
              -D LIBXML2_WITH_PYTHON=OFF \
              -D CMAKE_C_FLAGS="-fPIC" \
              -D LIBXML2_WITH_ZLIB=OFF "${CMAKE_TOOLCHAIN_FILE}"
          cd libxml2-build && \
              make -j$(nproc) && \
              make DESTDIR="${ROOT_DIR}/deps/libxml2" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libxml2-${LIBXML2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C libxml2 .

      - name: Cache compiled libc-ares
        uses: actions/cache@v3
        id: cache-libc-ares-shared
        with:
          path: |
            releases/libc-ares-${{ env.LIBCARES2_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-shared-libc-ares-${{ env.LIBCARES2_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile libc-ares
        if: steps.cache-libc-ares-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          if [ "${{ matrix.pair.arch }}" != "x86_64-linux-gnu" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
          fi
          tar -xzf "tarballs/libc-ares-${LIBCARES2_VERSION}.tar.gz" -C src
          cd "src/c-ares-${LIBCARES2_VERSION}"
          export CFLAGS="-fPIC"
          ./configure "${CONFIGURE_HOST}" --prefix=/usr/local --enable-shared=yes --enable-static=no
          make -j$(nproc) && \
              make DESTDIR="${ROOT_DIR}/deps/libc-ares" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libc-ares-${LIBCARES2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C libc-ares .

      - name: Cache compiled openssl
        uses: actions/cache@v3
        id: cache-openssl-shared
        with:
          path: |
            releases/openssl-${{ env.OPENSSL_VERSION }}-${{ matrix.pair.arch }}.tar.gz
            deps/openssl/
          key: releases-shared-openssl-${{ env.OPENSSL_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile openssl
        if: steps.cache-openssl-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_PARAM=""
          export CONFIGURE_PREFIX=""
          if [ "${{ matrix.pair.arch }}" != "x86_64-linux-gnu" ]; then
            export CONFIGURE_PARAM="${{ matrix.pair.openssl_configure }}"
            export CONFIGURE_PREFIX="${{ matrix.pair.openssl_prefix }}"
          fi
          tar -xzf "tarballs/openssl-${OPENSSL_VERSION}.tar.gz" -C src
          cd "src/openssl-${OPENSSL_VERSION}"
          export CFLAGS="-fPIC"
          ./Configure "${CONFIGURE_PARAM}" "${CONFIGURE_PREFIX}" --prefix=/usr/local
          make -j$(nproc)
          make DESTDIR="${ROOT_DIR}/deps/openssl" install_sw
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/openssl-${OPENSSL_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C openssl .

      - name: Cache compiled libssh2
        uses: actions/cache@v3
        id: cache-libssh2-shared
        with:
          path: |
            releases/libssh2-${{ env.LIBSSH2_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-shared-libssh2-${{ env.LIBSSH2_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile libssh2
        if: steps.cache-libssh2-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          if [ "${{ matrix.pair.arch }}" != "x86_64-linux-gnu" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
          fi
          tar -xzf "tarballs/libssh2-${LIBSSH2_VERSION}.tar.gz" -C src
          cd "src/libssh2-${LIBSSH2_VERSION}"
          export CFLAGS="-fPIC"
          ./configure --with-crypto=openssl \
            --with-libssl-prefix="${ROOT_DIR}/deps/openssl/usr/local" \
            --with-libgcrypt-prefix="${ROOT_DIR}/deps/openssl/usr/local" \
            --disable-tests \
            --disable-sshd-tests \
            --disable-examples-build \
            --enable-shared=yes --enable-static=no "${CONFIGURE_HOST}"
          make -j$(nproc)
          make DESTDIR="${ROOT_DIR}/deps/libssh2" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libssh2-${LIBSSH2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C libssh2 .

      - name: Cache compiled sqlite3
        uses: actions/cache@v3
        id: cache-sqlite3-shared
        with:
          path: |
            releases/sqlite3-${{ env.SQLITE3_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-shared-sqlite3-${{ env.SQLITE3_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile sqlite3
        if: steps.cache-sqlite3-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          if [ "${{ matrix.pair.arch }}" != "x86_64-linux-gnu" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
          fi
          tar -xzf "tarballs/sqlite-autoconf-${SQLITE3_VERSION}.tar.gz" -C src
          cd "src/sqlite-autoconf-${SQLITE3_VERSION}"
          export CFLAGS="-fPIC"
          ./configure --enable-shared=yes --enable-static=no "${CONFIGURE_HOST}"
          make -j$(nproc)
          make DESTDIR="${ROOT_DIR}/deps/sqlite3" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/sqlite3-${SQLITE3_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C sqlite3 .

      - name: Create release - phase 1
        run: |
          export ROOT_DIR=$(pwd)
          cd deps
          mkdir -p aria2-deps

          tar -xzf "${ROOT_DIR}/releases/libxml2-${LIBXML2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/libc-ares-${LIBCARES2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/openssl-${OPENSSL_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/libssh2-${LIBSSH2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/sqlite3-${SQLITE3_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/zlib-${ZLIB_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps

          tar -czf "${ROOT_DIR}/releases/aria2-deps-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps .

      - name: Cache compiled libaria2
        uses: actions/cache@v3
        id: cache-libaria2-shared
        with:
          path: |
            releases/libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-shared-libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}
      - name: Compile libaria2
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          if [ "${{ matrix.pair.arch }}" != "x86_64-linux-gnu" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
          fi
          sudo tar -xzf "${ROOT_DIR}/releases/aria2-deps-${{ matrix.pair.arch }}.tar.gz" -C /
          cd "src/aria2-${{ env.ARIA2_COMMIT }}"
          autoreconf -i
          export ZLIB_LIBS="-L${ROOT_DIR}/deps/aria2-deps/usr/local/lib -lz"
          export LDFLAGS="-Wl,-rpath,\$ORIGIN/lib:\$ORIGIN/lib64"
          ./configure --enable-shared --enable-libaria2 "${CONFIGURE_HOST}"
          make -j$(nproc)
          make DESTDIR="${ROOT_DIR}/deps/aria2" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}.tar.gz" -C aria2 .

      - name: Create release - phase 2
        run: |
          export ROOT_DIR=$(pwd)
          cd "${ROOT_DIR}/deps"
          tar -xzf "${ROOT_DIR}/releases/libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -czf "${ROOT_DIR}/releases/aria2-deps-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps .

      - uses: softprops/action-gh-release@v1
        with:
          files: releases/*.tar.gz

  macos:
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - pair:
              arch: x86_64-apple-darwin
              cpu_arch: x86_64
              cmake_osx_arch: CMAKE_OSX_ARCHITECTURES="x86_64"
              openssl_configure: darwin64-x86_64
          - pair:
              arch: arm64-apple-darwin
              cpu_arch: arm64
              cmake_osx_arch: CMAKE_OSX_ARCHITECTURES="arm64"
              openssl_configure: darwin64-arm64

    name: ${{ matrix.pair.arch }}

    steps:
      - uses: actions/checkout@v4
      - name: Create directories
        run: |
          mkdir -p "src"
          mkdir -p "tarballs"
          mkdir -p "deps"
          mkdir -p "releases"

      - name: Cache libxml2
        uses: actions/cache@v3
        id: cache-libxml2
        with:
          path: |
            tarballs/libxml2-${{ env.LIBXML2_VERSION }}.tar.gz
          key: tarballs-libxml2-${{ env.LIBXML2_VERSION }}
      - name: Get libxml2
        if: steps.cache-libxml2.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://github.com/GNOME/libxml2/archive/refs/tags/v${LIBXML2_VERSION}.tar.gz" -o "tarballs/libxml2-v${LIBXML2_VERSION}.tar.gz"

      - name: Cache libc-ares2
        uses: actions/cache@v3
        id: cache-libc-ares2
        with:
          path: |
            tarballs/c-ares-${{ env.LIBCARES2_VERSION }}.tar.gz
          key: tarballs-libc-ares-${{ env.LIBCARES2_VERSION }}
      - name: Get libc-ares2
        if: steps.cache-libc-ares2.outputs.cache-hit != 'true'
        run: |
          export LIBCARES2_VERSION_UNDERSCORE=${LIBCARES2_VERSION//./_}
          curl -fSL "https://github.com/c-ares/c-ares/releases/download/cares-${LIBCARES2_VERSION_UNDERSCORE}/c-ares-${LIBCARES2_VERSION}.tar.gz" -o "tarballs/libc-ares-${LIBCARES2_VERSION}.tar.gz"

      - name: Cache OpenSSL
        uses: actions/cache@v3
        id: cache-openssl
        with:
          path: |
            tarballs/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          key: tarballs-openssl-${{ env.OPENSSL_VERSION }}
      - name: Get OpenSSL
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" -o "tarballs/openssl-${OPENSSL_VERSION}.tar.gz"

      - name: Cache libssh2
        uses: actions/cache@v3
        id: cache-libssh2
        with:
          path: |
            tarballs/libssh2-${{ env.LIBSSH2_VERSION }}.tar.gz
          key: tarballs-libssh2-${{ env.LIBSSH2_VERSION }}
      - name: Get libssh2
        if: steps.cache-libssh2.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://libssh2.org/download/libssh2-${LIBSSH2_VERSION}.tar.gz" -o "tarballs/libssh2-${LIBSSH2_VERSION}.tar.gz"

      - name: Cache SQLite3
        uses: actions/cache@v3
        id: cache-sqlite3
        with:
          path: |
            tarballs/sqlite-autoconf-${{ env.SQLITE3_VERSION }}.tar.gz
          key: tarballs-sqlite3-${{ env.SQLITE3_VERSION }}
      - name: Get SQLite3
        if: steps.cache-sqlite3.outputs.cache-hit != 'true'
        run: |
          curl -fSL "https://www.sqlite.org/2023/sqlite-autoconf-${SQLITE3_VERSION}.tar.gz" -o "tarballs/sqlite-autoconf-${SQLITE3_VERSION}.tar.gz"

      - name: Cache aria2
        uses: actions/cache@v3
        id: cache-aria2
        with:
          path: |
            src/aria2-${{ env.ARIA2_COMMIT }}
          key: src-aria2-${{ env.ARIA2_COMMIT }}
      - name: Get aria2
        if: steps.cache-aria2.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/uwulab/aria2.git src/aria2
          cd src/aria2
          git checkout "${{ env.ARIA2_COMMIT }}"
          cd ..
          mv src/aria2 src/aria2-${{ env.ARIA2_COMMIT }}

      - name: Cache compiled libxml2
        uses: actions/cache@v3
        id: cache-libxml2-shared
        with:
          path: |
            releases/libxml2-${{ env.LIBXML2_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-libxml2-${{ env.LIBXML2_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile libxml2
        if: steps.cache-libxml2-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          tar -xzf "tarballs/libxml2-v${LIBXML2_VERSION}.tar.gz" -C src
          cd "src/libxml2-${LIBXML2_VERSION}"
          export CMAKE_TOOLCHAIN_FILE=-DCMAKE_TOOLCHAIN_FILE="${ROOT_DIR}/${{ matrix.pair.cmake_toolchain_file }}"
          if [ -z "${{ matrix.pair.cmake_toolchain_file }}" ]; then
            export CMAKE_TOOLCHAIN_FILE=""
          fi
          cmake -S . -B libxml2-build \
              -D BUILD_STATIC_LIBS=OFF \
              -D CMAKE_BUILD_TYPE=Release \
              -D CMAKE_INSTALL_PREFIX=/usr/local \
              -D LIBXML2_WITH_ICONV=OFF \
              -D LIBXML2_WITH_LZMA=OFF \
              -D LIBXML2_WITH_PYTHON=OFF \
              -D LIBXML2_WITH_ZLIB=OFF "${{ matrix.pair.cmake_osx_arch }}"
          cd libxml2-build && \
              make -j$(sysctl -n hw.ncpu) && \
              make DESTDIR="${ROOT_DIR}/deps/libxml2" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libxml2-${LIBXML2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C libxml2 .

      - name: Cache compiled libc-ares
        uses: actions/cache@v3
        id: cache-libc-ares-shared
        with:
          path: |
            releases/libc-ares-${{ env.LIBCARES2_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-libc-ares-${{ env.LIBCARES2_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile libc-ares
        if: steps.cache-libc-ares-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          export CFLAGS=""
          if [ "${{ matrix.pair.arch }}" == "arm64-apple-darwin" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
            export CC="gcc -arch arm64"
            export CXX="g++ -arch arm64"
            export CFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
            export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
          fi
          tar -xzf "tarballs/libc-ares-${LIBCARES2_VERSION}.tar.gz" -C src
          cd "src/c-ares-${LIBCARES2_VERSION}"
          ./configure "${CONFIGURE_HOST}" --prefix=/usr/local --enable-shared=yes --enable-static=no
          make -j$(sysctl -n hw.ncpu) && \
              make DESTDIR="${ROOT_DIR}/deps/libc-ares" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libc-ares-${LIBCARES2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C libc-ares .

      - name: Cache compiled openssl
        uses: actions/cache@v3
        id: cache-openssl-shared
        with:
          path: |
            releases/openssl-${{ env.OPENSSL_VERSION }}-${{ matrix.pair.arch }}.tar.gz
            deps/openssl/
          key: releases-openssl-${{ env.OPENSSL_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile openssl
        if: steps.cache-openssl-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_PARAM="${{ matrix.pair.openssl_configure }}"
          tar -xzf "tarballs/openssl-${OPENSSL_VERSION}.tar.gz" -C src
          cd "src/openssl-${OPENSSL_VERSION}"
          ./Configure "${CONFIGURE_PARAM}" --prefix=/usr/local
          make -j$(sysctl -n hw.ncpu)
          make DESTDIR="${ROOT_DIR}/deps/openssl" install_sw
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/openssl-${OPENSSL_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C openssl .

      - name: Cache compiled libssh2
        uses: actions/cache@v3
        id: cache-libssh2-shared
        with:
          path: |
            releases/libssh2-${{ env.LIBSSH2_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-libssh2-${{ env.LIBSSH2_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile libssh2
        if: steps.cache-libssh2-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          if [ "${{ matrix.pair.arch }}" == "arm64-apple-darwin" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
            export CC="gcc -arch arm64"
            export CXX="g++ -arch arm64"
            export CFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
            export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
          fi
          tar -xzf "tarballs/libssh2-${LIBSSH2_VERSION}.tar.gz" -C src
          cd "src/libssh2-${LIBSSH2_VERSION}"
          ./configure --disable-tests \
            --disable-sshd-tests \
            --disable-examples-build \
            --enable-shared=yes --enable-static=no "${CONFIGURE_HOST}"
          make -j$(sysctl -n hw.ncpu)
          make DESTDIR="${ROOT_DIR}/deps/libssh2" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libssh2-${LIBSSH2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C libssh2 .

      - name: Cache compiled sqlite3
        uses: actions/cache@v3
        id: cache-sqlite3-shared
        with:
          path: |
            releases/sqlite3-${{ env.SQLITE3_VERSION }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-sqlite3-${{ env.SQLITE3_VERSION }}-${{ matrix.pair.arch }}
      - name: Compile sqlite3
        if: steps.cache-sqlite3-shared.outputs.cache-hit != 'true'
        run: |
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          if [ "${{ matrix.pair.arch }}" != "x86_64-apple-darwin" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
            export CC="gcc -arch arm64"
            export CXX="g++ -arch arm64"
            export CFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
            export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
          fi
          tar -xzf "tarballs/sqlite-autoconf-${SQLITE3_VERSION}.tar.gz" -C src
          cd "src/sqlite-autoconf-${SQLITE3_VERSION}"
          ./configure --enable-shared=yes --enable-static=no "${CONFIGURE_HOST}"
          make -j$(sysctl -n hw.ncpu)
          make DESTDIR="${ROOT_DIR}/deps/sqlite3" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/sqlite3-${SQLITE3_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C sqlite3 .

      - name: Create release - phase 1
        run: |
          export ROOT_DIR=$(pwd)
          cd deps
          mkdir -p aria2-deps

          tar -xzf "${ROOT_DIR}/releases/libxml2-${LIBXML2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/libc-ares-${LIBCARES2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/openssl-${OPENSSL_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/libssh2-${LIBSSH2_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -xzf "${ROOT_DIR}/releases/sqlite3-${SQLITE3_VERSION}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps

          tar -czf "${ROOT_DIR}/releases/aria2-deps-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps .

      - name: Cache compiled libaria2
        uses: actions/cache@v3
        id: cache-libaria2-shared
        with:
          path: |
            releases/libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}.tar.gz
          key: releases-shared-libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}
      - name: Compile libaria2
        run: |
          brew install autoconf automake libtool
          export ROOT_DIR=$(pwd)
          export CONFIGURE_HOST=""
          export LDFLAGS="-Wl,-rpath @loader_path/lib"
          if [ "${{ matrix.pair.arch }}" != "x86_64-apple-darwin" ]; then
            export CONFIGURE_HOST="--host=${{ matrix.pair.arch }}"
            export CC="gcc -arch arm64"
            export CXX="g++ -arch arm64"
            export CFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11"
            export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0 -target arm64-apple-macos11 -L/usr/local/lib -lcrypto -lxml2 ${LDFLAGS}"
          fi
          sudo tar -xzf "${ROOT_DIR}/releases/aria2-deps-${{ matrix.pair.arch }}.tar.gz" -C /
          cd "src/aria2-${{ env.ARIA2_COMMIT }}"
          autoreconf -i
          ./configure --enable-shared --enable-libaria2 "${CONFIGURE_HOST}"
          make -j$(nproc)
          make DESTDIR="${ROOT_DIR}/deps/aria2" install
          cd "${ROOT_DIR}/deps"
          tar -czf "${ROOT_DIR}/releases/libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}.tar.gz" -C aria2 .

      - name: Create release - phase 2
        run: |
          export ROOT_DIR=$(pwd)
          cd "${ROOT_DIR}/deps"
          tar -xzf "${ROOT_DIR}/releases/libaria2-${{ env.ARIA2_COMMIT_SHORT }}-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps
          tar -czf "${ROOT_DIR}/releases/aria2-deps-${{ matrix.pair.arch }}.tar.gz" -C aria2-deps .

      - uses: softprops/action-gh-release@v1
        with:
          files: releases/*.tar.gz
